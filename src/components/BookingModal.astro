---
import { getLangFromUrl, useTranslations } from '../i18n/utils';

const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
---
<div id="booking-modal" class="fixed inset-0 z-[100] hidden" aria-labelledby="modal-title" role="dialog" aria-modal="true">
  <div class="fixed inset-0 bg-dark/60 backdrop-blur-sm transition-opacity opacity-0" id="modal-backdrop"></div>

  <div class="fixed inset-0 z-10 w-screen overflow-y-auto">
    <div class="flex min-h-full items-center justify-center p-4 text-center sm:p-0">
      <div class="relative transform overflow-hidden rounded-2xl bg-sand text-left shadow-2xl transition-all sm:my-8 sm:w-full sm:max-w-lg opacity-0 translate-y-4 sm:translate-y-0 sm:scale-95" id="modal-panel">

        <button id="close-modal" class="absolute right-4 top-4 text-dark/50 hover:text-dark transition p-2 z-10">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
                <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
            </svg>
        </button>

        <div class="px-6 py-8 md:px-8 md:py-10">
            <div id="form-state">
                <div class="text-center mb-6">
                    <h3 class="text-2xl font-serif font-bold text-ocean">{t('booking.title')}</h3>
                    <p class="text-sm text-dark/70 mt-2">{t('booking.subtitle')}</p>
                </div>

                <form id="booking-form" class="space-y-4"
                      data-msg-sending={t('booking.js.sending')}
                      data-msg-error={t('booking.js.error')}>

                    <input type="hidden" name="access_key" value="ebc4ca49-4599-46ba-a0bf-ea764c04c468">
                    <input type="hidden" name="subject" value="Nouvelle Réservation - Global Surf">
                    <input type="hidden" name="from_name" value="Site Web">
                    <input type="checkbox" name="botcheck" class="hidden" style="display: none;">

                    <div class="space-y-4">
                        <div>
                            <label for="name" class="block text-xs font-bold uppercase tracking-widest text-dark mb-1 ml-1">{t('booking.label.name')}</label>
                            <input type="text" name="name" id="name" required class="w-full bg-white border border-stone-200 rounded-lg px-4 py-3 focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra transition placeholder-stone-400" placeholder={t('booking.placeholder.name')} />
                        </div>
                        <div>
                            <label for="email" class="block text-xs font-bold uppercase tracking-widest text-dark mb-1 ml-1">{t('booking.label.email')}</label>
                            <input type="email" name="email" id="email" required class="w-full bg-white border border-stone-200 rounded-lg px-4 py-3 focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra transition placeholder-stone-400" placeholder={t('booking.placeholder.email')} />
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label for="date" class="block text-xs font-bold uppercase tracking-widest text-dark mb-1 ml-1">{t('booking.label.arrival')}</label>
                            <input type="date" name="date" id="date" required class="w-full bg-white border border-stone-200 rounded-lg px-4 py-3 focus:outline-none focus:border-terra transition text-stone-600" />
                        </div>
                        <div>
                            <label for="guests" class="block text-xs font-bold uppercase tracking-widest text-dark mb-1 ml-1">{t('booking.label.guests')}</label>
                            <select name="guests" id="guests" class="w-full bg-white border border-stone-200 rounded-lg px-4 py-3 focus:outline-none focus:border-terra transition text-stone-600">
                                <option value="1 personne">{t('booking.guests.1')}</option>
                                <option value="2 personnes">{t('booking.guests.2')}</option>
                                <option value="3 personnes">{t('booking.guests.3')}</option>
                                <option value="4+ groupe">{t('booking.guests.group')}</option>
                            </select>
                        </div>
                    </div>

                    <div>
                         <label for="interest" class="block text-xs font-bold uppercase tracking-widest text-dark mb-1 ml-1">{t('booking.label.interest')}</label>
                         <select name="interest" id="interest" class="w-full bg-white border border-stone-200 rounded-lg px-4 py-3 focus:outline-none focus:border-terra transition text-stone-600">
                            <option value="general">{t('booking.interest.general')}</option>
                            <option value="surf">{t('booking.interest.surf')}</option>
                            <option value="trips">{t('booking.interest.trips')}</option>
                            <option value="sejours">{t('booking.interest.sejours')}</option>
                            <option value="experiences">{t('booking.interest.experiences')}</option>
                            <option value="housing">{t('booking.interest.housing')}</option>
                        </select>
                    </div>

                    <div>
                        <label for="message" class="block text-xs font-bold uppercase tracking-widest text-dark mb-1 ml-1">{t('booking.label.message')}</label>
                        <textarea name="message" id="message" rows="3" class="w-full bg-white border border-stone-200 rounded-lg px-4 py-3 focus:outline-none focus:border-terra focus:ring-1 focus:ring-terra transition placeholder-stone-400 resize-none" placeholder={t('booking.placeholder.message')}></textarea>
                    </div>

                    <div id="result" class="text-center text-sm mb-2 hidden"></div>

                    <button type="submit" class="w-full bg-terra text-white font-bold py-4 rounded-xl shadow-lg hover:bg-terra/90 hover:-translate-y-0.5 transition-all duration-300 mt-2">
                        {t('booking.submit')}
                    </button>
                    <p class="text-[10px] text-center text-dark/40 uppercase tracking-wider">{t('booking.subtext')}</p>
                </form>
            </div>

            <div id="success-state" class="hidden text-center py-10">
                <div class="mx-auto flex h-20 w-20 items-center justify-center rounded-full bg-ocean/10 mb-6 animate-pulse">
                    <svg class="h-10 w-10 text-ocean" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                    </svg>
                </div>
                <h3 class="text-3xl font-serif font-bold text-ocean mb-4">{t('booking.success.title')}</h3>
                <p class="text-dark/80 mb-8 max-w-xs mx-auto">{t('booking.success.text')}</p>
                <button id="close-success" class="bg-dark text-white px-8 py-3 rounded-full font-bold uppercase tracking-widest text-xs shadow-lg hover:bg-dark/90 transition">
                    {t('booking.success.back')}
                </button>
            </div>

        </div>
      </div>
    </div>
  </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        const modal = document.getElementById('booking-modal');
        const backdrop = document.getElementById('modal-backdrop');
        const panel = document.getElementById('modal-panel');
        const closeBtn = document.getElementById('close-modal');
        const closeSuccessBtn = document.getElementById('close-success');
        const form = document.getElementById('booking-form') as HTMLFormElement;
        const formState = document.getElementById('form-state');
        const successState = document.getElementById('success-state');
        const interestSelect = document.getElementById('interest') as HTMLSelectElement;
        const result = document.getElementById('result');

        // Récupération des textes traduits depuis les attributs data
        const msgSending = form?.getAttribute('data-msg-sending') || 'Envoi...';
        const msgError = form?.getAttribute('data-msg-error') || 'Erreur.';

        // --- GESTION DE L'OUVERTURE / FERMETURE DU MODAL ---
        window.openBookingModal = () => {
            if(!modal) return;
            modal.classList.remove('hidden');
            setTimeout(() => {
                backdrop.classList.remove('opacity-0');
                panel.classList.remove('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');
                panel.classList.add('opacity-100', 'translate-y-0', 'sm:scale-100');
            }, 10);
            document.body.style.overflow = 'hidden';
        };

        const closeModal = () => {
            if(!modal) return;
            backdrop.classList.add('opacity-0');
            panel.classList.remove('opacity-100', 'translate-y-0', 'sm:scale-100');
            panel.classList.add('opacity-0', 'translate-y-4', 'sm:translate-y-0', 'sm:scale-95');

            setTimeout(() => {
                modal.classList.add('hidden');
                // On réinitialise l'état pour la prochaine fois
                setTimeout(() => {
                     formState.classList.remove('hidden');
                     successState.classList.add('hidden');
                     form.reset();
                     if(result) {
                        result.classList.add('hidden');
                        result.innerText = '';
                     }
                     // Reset bouton
                     const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
                     if(btn) {
                        btn.disabled = false;
                        btn.classList.remove('opacity-75', 'cursor-not-allowed');
                        // Note: Le texte du bouton sera remis lors du prochain chargement de page ou reset manuel
                        // Pour faire simple, on laisse tel quel car le modal est caché
                     }
                }, 100);
            }, 300);
            document.body.style.overflow = 'auto';
        };

        closeBtn?.addEventListener('click', closeModal);
        closeSuccessBtn?.addEventListener('click', closeModal);

        modal?.addEventListener('click', (e) => {
            if (e.target === modal || e.target.closest('#modal-backdrop')) {
                closeModal();
            }
        });

        // Pré-sélection de la formule quand on clique sur "Réserver"
        document.querySelectorAll('.js-open-booking').forEach(btn => {
            btn.addEventListener('click', (e) => {
                e.preventDefault();
                const formula = btn.getAttribute('data-formula');
                if (formula && interestSelect) {
                    interestSelect.value = formula;
                } else if (interestSelect) {
                    interestSelect.value = 'general';
                }
                window.openBookingModal();
            });
        });

        // --- SOUMISSION DU FORMULAIRE (LOGIQUE D'ENVOI) ---
        form?.addEventListener('submit', function(e) {
          e.preventDefault();

          const formData = new FormData(form);
          const object = Object.fromEntries(formData);
          const json = JSON.stringify(object);

          if(result) {
            result.innerText = msgSending; // Utilisation du texte traduit
            result.classList.remove('hidden', 'text-red-500');
            result.classList.add('text-gray-500');
          }

          const btn = form.querySelector('button[type="submit"]') as HTMLButtonElement;
          const originalText = btn.innerText;
          btn.innerText = msgSending; // Utilisation du texte traduit
          btn.disabled = true;
          btn.classList.add('opacity-75', 'cursor-not-allowed');

          fetch('https://api.web3forms.com/submit', {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json',
                  'Accept': 'application/json'
              },
              body: json
          })
          .then(async (response) => {
              let json = await response.json();
              if (response.status == 200) {
                  // SUCCÈS
                  formState.classList.add('hidden');
                  successState.classList.remove('hidden');
              } else {
                  // ERREUR
                  console.log(response);
                  if(result) {
                    result.innerText = json.message || msgError;
                    result.classList.remove('text-gray-500');
                    result.classList.add('text-red-500');
                  }
                  btn.innerText = originalText;
                  btn.disabled = false;
                  btn.classList.remove('opacity-75', 'cursor-not-allowed');
              }
          })
          .catch(error => {
              console.log(error);
              if(result) {
                  result.innerText = msgError; // Utilisation du texte traduit
                  result.classList.remove('text-gray-500');
                  result.classList.add('text-red-500');
              }
              btn.innerText = originalText;
              btn.disabled = false;
              btn.classList.remove('opacity-75', 'cursor-not-allowed');
          });
        });
    });
</script>
